{"ast":null,"code":"'use strict';\n\nrequire(\"core-js/modules/es.array.push.js\");\nObject.defineProperty(exports, '__esModule', {\n  value: true\n});\nvar vue = require('vue');\nvar lodashUnified = require('lodash-unified');\nrequire('../../../../utils/index.js');\nvar constants = require('../constants.js');\nvar types = require('../../../../utils/types.js');\nconst useRow = (props, {\n  mainTableRef,\n  leftTableRef,\n  rightTableRef\n}) => {\n  const vm = vue.getCurrentInstance();\n  const {\n    emit\n  } = vm;\n  const isResetting = vue.shallowRef(false);\n  const hoveringRowKey = vue.shallowRef(null);\n  const expandedRowKeys = vue.ref(props.defaultExpandedRowKeys || []);\n  const lastRenderedRowIndex = vue.ref(-1);\n  const resetIndex = vue.shallowRef(null);\n  const rowHeights = vue.ref({});\n  const pendingRowHeights = vue.ref({});\n  const leftTableHeights = vue.shallowRef({});\n  const mainTableHeights = vue.shallowRef({});\n  const rightTableHeights = vue.shallowRef({});\n  const isDynamic = vue.computed(() => types.isNumber(props.estimatedRowHeight));\n  function onRowsRendered(params) {\n    var _a;\n    (_a = props.onRowsRendered) == null ? void 0 : _a.call(props, params);\n    if (params.rowCacheEnd > vue.unref(lastRenderedRowIndex)) {\n      lastRenderedRowIndex.value = params.rowCacheEnd;\n    }\n  }\n  function onRowHovered({\n    hovered,\n    rowKey\n  }) {\n    hoveringRowKey.value = hovered ? rowKey : null;\n  }\n  function onRowExpanded({\n    expanded,\n    rowData,\n    rowIndex,\n    rowKey\n  }) {\n    var _a, _b;\n    const _expandedRowKeys = [...vue.unref(expandedRowKeys)];\n    const currentKeyIndex = _expandedRowKeys.indexOf(rowKey);\n    if (expanded) {\n      if (currentKeyIndex === -1) _expandedRowKeys.push(rowKey);\n    } else {\n      if (currentKeyIndex > -1) _expandedRowKeys.splice(currentKeyIndex, 1);\n    }\n    expandedRowKeys.value = _expandedRowKeys;\n    emit(\"update:expandedRowKeys\", _expandedRowKeys);\n    (_a = props.onRowExpand) == null ? void 0 : _a.call(props, {\n      expanded,\n      rowData,\n      rowIndex,\n      rowKey\n    });\n    (_b = props.onExpandedRowsChange) == null ? void 0 : _b.call(props, _expandedRowKeys);\n  }\n  const flushingRowHeights = lodashUnified.debounce(() => {\n    var _a, _b, _c, _d;\n    isResetting.value = true;\n    rowHeights.value = {\n      ...vue.unref(rowHeights),\n      ...vue.unref(pendingRowHeights)\n    };\n    resetAfterIndex(vue.unref(resetIndex), false);\n    pendingRowHeights.value = {};\n    resetIndex.value = null;\n    (_a = mainTableRef.value) == null ? void 0 : _a.forceUpdate();\n    (_b = leftTableRef.value) == null ? void 0 : _b.forceUpdate();\n    (_c = rightTableRef.value) == null ? void 0 : _c.forceUpdate();\n    (_d = vm.proxy) == null ? void 0 : _d.$forceUpdate();\n    isResetting.value = false;\n  }, 0);\n  function resetAfterIndex(index, forceUpdate = false) {\n    if (!vue.unref(isDynamic)) return;\n    [mainTableRef, leftTableRef, rightTableRef].forEach(tableRef => {\n      const table = vue.unref(tableRef);\n      if (table) table.resetAfterRowIndex(index, forceUpdate);\n    });\n  }\n  function resetHeights(rowKey, height, rowIdx) {\n    const resetIdx = vue.unref(resetIndex);\n    if (resetIdx === null) {\n      resetIndex.value = rowIdx;\n    } else {\n      if (resetIdx > rowIdx) {\n        resetIndex.value = rowIdx;\n      }\n    }\n    pendingRowHeights.value[rowKey] = height;\n  }\n  function onRowHeightChange({\n    rowKey,\n    height,\n    rowIndex\n  }, fixedDir) {\n    if (!fixedDir) {\n      mainTableHeights.value[rowKey] = height;\n    } else {\n      if (fixedDir === constants.FixedDir.RIGHT) {\n        rightTableHeights.value[rowKey] = height;\n      } else {\n        leftTableHeights.value[rowKey] = height;\n      }\n    }\n    const maximumHeight = Math.max(...[leftTableHeights, rightTableHeights, mainTableHeights].map(records => records.value[rowKey] || 0));\n    if (vue.unref(rowHeights)[rowKey] !== maximumHeight) {\n      resetHeights(rowKey, maximumHeight, rowIndex);\n      flushingRowHeights();\n    }\n  }\n  return {\n    hoveringRowKey,\n    expandedRowKeys,\n    lastRenderedRowIndex,\n    isDynamic,\n    isResetting,\n    rowHeights,\n    resetAfterIndex,\n    onRowExpanded,\n    onRowHovered,\n    onRowsRendered,\n    onRowHeightChange\n  };\n};\nexports.useRow = useRow;","map":{"version":3,"names":["useRow","props","mainTableRef","leftTableRef","rightTableRef","vm","vue","getCurrentInstance","emit","isResetting","shallowRef","hoveringRowKey","expandedRowKeys","ref","defaultExpandedRowKeys","lastRenderedRowIndex","resetIndex","rowHeights","pendingRowHeights","leftTableHeights","mainTableHeights","rightTableHeights","isDynamic","computed","types","isNumber","estimatedRowHeight","onRowsRendered","params","_a","call","rowCacheEnd","unref","value","onRowHovered","hovered","rowKey","onRowExpanded","expanded","rowData","rowIndex","_b","_expandedRowKeys","currentKeyIndex","indexOf","push","splice","onRowExpand","onExpandedRowsChange","flushingRowHeights","lodashUnified","debounce","_c","_d","resetAfterIndex","forceUpdate","proxy","$forceUpdate","index","forEach","tableRef","table","resetAfterRowIndex","resetHeights","height","rowIdx","resetIdx","onRowHeightChange","fixedDir","constants","FixedDir","RIGHT","maximumHeight","Math","max","map","records"],"sources":["../../../../../../../packages/components/table-v2/src/composables/use-row.ts"],"sourcesContent":["import { computed, getCurrentInstance, ref, shallowRef, unref } from 'vue'\nimport { debounce } from 'lodash-unified'\nimport { isNumber } from '@element-plus/utils'\nimport { FixedDir } from '../constants'\n\nimport type { Ref } from 'vue'\nimport type { TableV2Props } from '../table'\nimport type {\n  RowExpandParams,\n  RowHeightChangedParams,\n  RowHoverParams,\n} from '../row'\nimport type { FixedDirection, KeyType } from '../types'\nimport type { onRowRenderedParams } from '../grid'\nimport type { TableGridInstance } from '../table-grid'\n\ntype Heights = Record<KeyType, number>\ntype GridInstanceRef = Ref<TableGridInstance | undefined>\n\ntype UseRowProps = {\n  mainTableRef: GridInstanceRef\n  leftTableRef: GridInstanceRef\n  rightTableRef: GridInstanceRef\n}\n\nexport const useRow = (\n  props: TableV2Props,\n  { mainTableRef, leftTableRef, rightTableRef }: UseRowProps\n) => {\n  const vm = getCurrentInstance()!\n  const { emit } = vm\n  const isResetting = shallowRef(false)\n  const hoveringRowKey = shallowRef<KeyType | null>(null)\n  const expandedRowKeys = ref<KeyType[]>(props.defaultExpandedRowKeys || [])\n  const lastRenderedRowIndex = ref(-1)\n  const resetIndex = shallowRef<number | null>(null)\n  const rowHeights = ref<Heights>({})\n  const pendingRowHeights = ref<Heights>({})\n  const leftTableHeights = shallowRef<Heights>({})\n  const mainTableHeights = shallowRef<Heights>({})\n  const rightTableHeights = shallowRef<Heights>({})\n  const isDynamic = computed(() => isNumber(props.estimatedRowHeight))\n\n  function onRowsRendered(params: onRowRenderedParams) {\n    props.onRowsRendered?.(params)\n\n    if (params.rowCacheEnd > unref(lastRenderedRowIndex)) {\n      lastRenderedRowIndex.value = params.rowCacheEnd\n    }\n  }\n\n  function onRowHovered({ hovered, rowKey }: RowHoverParams) {\n    hoveringRowKey.value = hovered ? rowKey : null\n  }\n\n  function onRowExpanded({\n    expanded,\n    rowData,\n    rowIndex,\n    rowKey,\n  }: RowExpandParams) {\n    const _expandedRowKeys = [...unref(expandedRowKeys)]\n    const currentKeyIndex = _expandedRowKeys.indexOf(rowKey)\n    if (expanded) {\n      if (currentKeyIndex === -1) _expandedRowKeys.push(rowKey)\n    } else {\n      if (currentKeyIndex > -1) _expandedRowKeys.splice(currentKeyIndex, 1)\n    }\n    expandedRowKeys.value = _expandedRowKeys\n\n    emit('update:expandedRowKeys', _expandedRowKeys)\n    props.onRowExpand?.({\n      expanded,\n      rowData,\n      rowIndex,\n      rowKey,\n    })\n    // If this is not controlled, then use this to notify changes\n    props.onExpandedRowsChange?.(_expandedRowKeys)\n  }\n\n  const flushingRowHeights = debounce(() => {\n    isResetting.value = true\n    rowHeights.value = { ...unref(rowHeights), ...unref(pendingRowHeights) }\n    resetAfterIndex(unref(resetIndex)!, false)\n    pendingRowHeights.value = {}\n    // force update\n    resetIndex.value = null\n    mainTableRef.value?.forceUpdate()\n    leftTableRef.value?.forceUpdate()\n    rightTableRef.value?.forceUpdate()\n    vm.proxy?.$forceUpdate()\n    isResetting.value = false\n  }, 0)\n\n  function resetAfterIndex(index: number, forceUpdate = false) {\n    if (!unref(isDynamic)) return\n    ;[mainTableRef, leftTableRef, rightTableRef].forEach((tableRef) => {\n      const table = unref(tableRef)\n      if (table) table.resetAfterRowIndex(index, forceUpdate)\n    })\n  }\n\n  function resetHeights(rowKey: KeyType, height: number, rowIdx: number) {\n    const resetIdx = unref(resetIndex)\n    if (resetIdx === null) {\n      resetIndex.value = rowIdx\n    } else {\n      if (resetIdx > rowIdx) {\n        resetIndex.value = rowIdx\n      }\n    }\n\n    pendingRowHeights.value[rowKey] = height\n  }\n\n  function onRowHeightChange(\n    { rowKey, height, rowIndex }: RowHeightChangedParams,\n    fixedDir: FixedDirection\n  ) {\n    if (!fixedDir) {\n      mainTableHeights.value[rowKey] = height\n    } else {\n      if (fixedDir === FixedDir.RIGHT) {\n        rightTableHeights.value[rowKey] = height\n      } else {\n        leftTableHeights.value[rowKey] = height\n      }\n    }\n\n    const maximumHeight = Math.max(\n      ...[leftTableHeights, rightTableHeights, mainTableHeights].map(\n        (records) => records.value[rowKey] || 0\n      )\n    )\n\n    if (unref(rowHeights)[rowKey] !== maximumHeight) {\n      resetHeights(rowKey, maximumHeight, rowIndex)\n      flushingRowHeights()\n    }\n  }\n\n  return {\n    hoveringRowKey,\n    expandedRowKeys,\n    lastRenderedRowIndex,\n    isDynamic,\n    isResetting,\n    rowHeights,\n\n    resetAfterIndex,\n    onRowExpanded,\n    onRowHovered,\n    onRowsRendered,\n    onRowHeightChange,\n  }\n}\n\nexport type UseRowReturn = ReturnType<typeof useRow>\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}